-- USERS
CREATE TABLE users (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  display_name VARCHAR(64),
  icon_url VARCHAR(1024),
  premium_flag BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- H2 互換のため visibility は文字列で管理（本番PGでENUM化する予定）
CREATE TABLE diaries (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id BIGINT NOT NULL,
  visibility VARCHAR(16) NOT NULL DEFAULT 'PRIVATE', -- PRIVATE / LIMITED / PUBLIC
  content CLOB NOT NULL,
  content_ai CLOB,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_diaries_user FOREIGN KEY (user_id) REFERENCES users(id)
);

CREATE TABLE likes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  diary_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT uq_likes UNIQUE (diary_id, user_id),
  CONSTRAINT fk_likes_diary FOREIGN KEY (diary_id) REFERENCES diaries(id) ON DELETE CASCADE,
  CONSTRAINT fk_likes_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE
);

CREATE TABLE comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  diary_id BIGINT NOT NULL,
  user_id BIGINT NOT NULL,
  body CLOB NOT NULL,
  parent_comment_id BIGINT,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT fk_comments_diary FOREIGN KEY (diary_id) REFERENCES diaries(id) ON DELETE CASCADE,
  CONSTRAINT fk_comments_user  FOREIGN KEY (user_id)  REFERENCES users(id)   ON DELETE CASCADE,
  CONSTRAINT fk_comments_parent FOREIGN KEY (parent_comment_id) REFERENCES comments(id) ON DELETE SET NULL
);
